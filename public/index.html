<!DOCTYPE html>
<html lang="zh">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Telegram Bot 管理面板</title>
		<!-- Tailwind CSS -->
		<script src="https://cdn.tailwindcss.com"></script>
		<!-- Chart.js -->
		<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.0/chart.min.js"></script>
		<style>
			/* 自定义样式 */
			.stats-card {
				transition: all 0.3s ease;
			}
			.stats-card:hover {
				transform: translateY(-2px);
				box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1),
					0 2px 4px -1px rgba(0, 0, 0, 0.06);
			}
		</style>
	</head>
	<body class="bg-gray-100">
		<div class="container mx-auto px-4 py-8">
			<div class="text-center mb-8">
				<h1 class="text-3xl font-bold text-gray-800 mb-2">
					Telegram Bot 管理面板
				</h1>
				<p class="text-gray-600">实时监控和管理您的 Bot</p>
			</div>

			<div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
				<!-- Bot 状态卡片 -->
				<div class="stats-card bg-white rounded-lg shadow p-6">
					<h2 class="text-xl font-semibold mb-2">Bot 状态</h2>
					<div class="flex items-center">
						<span id="botStatus" class="flex items-center">
							<span class="h-3 w-3 rounded-full bg-green-500 mr-2"></span>
							正在运行
						</span>
					</div>
					<p id="uptime" class="text-sm text-gray-500 mt-2">运行时间: 0小时</p>
				</div>

				<!-- 今日消息数卡片 -->
				<div class="stats-card bg-white rounded-lg shadow p-6">
					<h2 class="text-xl font-semibold mb-2">今日消息数</h2>
					<div id="messageCount" class="text-3xl font-bold text-blue-600">
						0
					</div>
					<p id="commandCount" class="text-sm text-gray-500 mt-2">
						命令使用: 0
					</p>
				</div>

				<!-- 活跃用户数卡片 -->
				<div class="stats-card bg-white rounded-lg shadow p-6">
					<h2 class="text-xl font-semibold mb-2">活跃用户数</h2>
					<div id="activeUsers" class="text-3xl font-bold text-green-600">
						0
					</div>
					<p id="totalUsers" class="text-sm text-gray-500 mt-2">总用户: 0</p>
				</div>

				<!-- 系统状态卡片 -->
				<div class="stats-card bg-white rounded-lg shadow p-6">
					<h2 class="text-xl font-semibold mb-2">系统状态</h2>
					<div id="systemLoad" class="text-3xl font-bold text-purple-600">
						正常
					</div>
					<p id="lastUpdate" class="text-sm text-gray-500 mt-2">
						最后更新: 刚刚
					</p>
				</div>
			</div>

			<div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
				<!-- 消息趋势图表 -->
				<div class="bg-white rounded-lg shadow p-6">
					<h2 class="text-xl font-semibold mb-4">消息趋势</h2>
					<canvas id="messageChart" height="200"></canvas>
				</div>

				<!-- 用户反馈列表 -->
				<div class="bg-white rounded-lg shadow p-6">
					<h2 class="text-xl font-semibold mb-4">最近用户反馈</h2>
					<div id="feedbackList" class="space-y-4">
						<!-- 反馈内容将通过 JavaScript 动态插入 -->
					</div>
				</div>
			</div>

			<!-- 系统日志区域 -->
			<div class="bg-white rounded-lg shadow p-6">
				<h2 class="text-xl font-semibold mb-4">系统日志</h2>
				<div class="bg-gray-100 p-4 rounded-md">
					<pre
						id="systemLogs"
						class="text-sm text-gray-700 whitespace-pre-wrap h-64 overflow-y-auto"></pre>
				</div>
			</div>
		</div>

		<script>
			// 全局变量
			let messageChart;
			let lastUpdateTime = new Date();

			// 初始化页面
			document.addEventListener('DOMContentLoaded', () => {
				initializeChart();
				startDataPolling();
			});

			// 初始化图表
			function initializeChart() {
				const ctx = document.getElementById('messageChart').getContext('2d');
				messageChart = new Chart(ctx, {
					type: 'line',
					data: {
						labels: Array.from({ length: 24 }, (_, i) => `${i}:00`),
						datasets: [
							{
								label: '消息数量',
								data: Array(24).fill(0),
								borderColor: 'rgb(59, 130, 246)',
								tension: 0.3,
								fill: false,
							},
						],
					},
					options: {
						responsive: true,
						scales: {
							y: {
								beginAtZero: true,
								ticks: {
									precision: 0,
								},
							},
						},
						plugins: {
							legend: {
								display: false,
							},
						},
					},
				});
			}

			// 开始数据轮询
			function startDataPolling() {
				fetchDashboardData();
				setInterval(fetchDashboardData, 60000); // 每分钟更新一次
			}

			// 获取仪表盘数据
			async function fetchDashboardData() {
				try {
					const response = await fetch('/api/stats');
					if (!response.ok) {
						throw new Error('API 请求失败');
					}
					const data = await response.json();
					updateDashboard(data);
					lastUpdateTime = new Date();
					document.getElementById(
						'lastUpdate'
					).textContent = `最后更新: ${lastUpdateTime.toLocaleTimeString()}`;
				} catch (error) {
					console.error('获取数据失败:', error);
					document.getElementById('systemLoad').textContent = '连接错误';
					document.getElementById('systemLoad').className =
						'text-3xl font-bold text-red-600';
				}
			}

			// 更新仪表盘显示
			function updateDashboard(data) {
				// 更新状态卡片
				document.getElementById('messageCount').textContent =
					data.dailyStats?.totalMessages || 0;
				document.getElementById('commandCount').textContent = `命令使用: ${
					data.dailyStats?.commands || 0
				}`;
				document.getElementById('activeUsers').textContent =
					data.dailyStats?.uniqueUsers || 0;
				document.getElementById('uptime').textContent = `运行时间: ${Math.floor(
					data.systemStatus?.uptimeHours || 0
				)}小时`;

				// 更新系统状态
				const statusIndicator =
					document.getElementById('botStatus').firstElementChild;
				if (data.systemStatus?.status === 'active') {
					statusIndicator.className = 'h-3 w-3 rounded-full bg-green-500 mr-2';
				} else {
					statusIndicator.className = 'h-3 w-3 rounded-full bg-yellow-500 mr-2';
				}

				// 更新图表数据
				if (data.messageHistory) {
					updateChart(data.messageHistory);
				}

				// 更新反馈列表
				if (data.recentFeedback) {
					updateFeedbackList(data.recentFeedback);
				}

				// 更新系统日志
				if (data.systemLogs) {
					updateSystemLogs(data.systemLogs);
				}
			}

			// 更新反馈列表
			function updateFeedbackList(feedback) {
				const feedbackList = document.getElementById('feedbackList');
				feedbackList.innerHTML = feedback
					.map(
						(item) => `
                <div class="border-l-4 border-blue-500 pl-4">
                    <p class="text-sm">${item.comment}</p>
                    <div class="text-xs text-gray-500 mt-1">
                        用户 ID: ${item.userId}
                        <span class="ml-2">${new Date(
													item.timestamp
												).toLocaleString()}</span>
                    </div>
                </div>
            `
					)
					.join('');
			}

			// 更新系统日志
			function updateSystemLogs(logs) {
				const systemLogs = document.getElementById('systemLogs');
				systemLogs.innerHTML = logs
					.map(
						(log) =>
							`[${new Date(log.timestamp).toLocaleString()}] ${log.message}`
					)
					.join('\n');
				systemLogs.scrollTop = systemLogs.scrollHeight;
			}

			// 更新图表
			function updateChart(messageHistory) {
				const hours = new Date().getHours();
				const data = Array(24).fill(0);
				messageHistory.forEach((item) => {
					const hour = new Date(item.timestamp).getHours();
					data[hour] = item.count;
				});

				messageChart.data.datasets[0].data = data;
				messageChart.update();
			}
		</script>
	</body>
</html>
